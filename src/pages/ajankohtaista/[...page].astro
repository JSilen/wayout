---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths({ paginate }) {
  const allPosts = await getCollection("ajankohtaista");
  
  // Lajitellaan postaukset: uusin ensin
  const sortedPosts = allPosts.sort(
    (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
  );

  // 6 postausta per sivu
  return paginate(sortedPosts, { pageSize: 6 });
}

const { page } = Astro.props;

// Formatointi
const formatDate = (dateString) => {
  const date = new Date(dateString);
  return date.toLocaleDateString("fi-FI");
};

// Luodaan sivunumerot
const pageNumbers = Array.from({ length: page.lastPage }, (_, i) => i + 1);
---

<Layout
  title={`Ajankohtaista - Sivu ${page.currentPage}`}
  description="Lue uusimmat uutiset ja vinkit web-kehityksestä."0
>
  <section class="w-full relative min-h-[300px] md:min-h-[400px] flex justify-center">
    <div class="max-w-8xl w-full relative">
      <picture>
        <source media="(min-width: 768px)" srcset="/images/uploads/bg-green-d.webp" />
        <img
          src="/images/uploads/bg-green-m.webp"
          alt=""
          class="absolute inset-0 w-full h-full object-cover -z-10 pointer-events-none"
        />
      </picture>

      <div class="relative z-10 py-s-10-m px-s-3-m md:py-s-10-d md:px-[68px]">
        <div>
          <h1 class="text-h1-m md:text-h1-d font-heading md:leading-[84px] md:pb-s-3-d pb-s-5-m">
            Ajankohtaista
          </h1>
        </div>

        <div class="inline-flex justify-start items-end gap-16">
          <p class="md:w-[641px] justify-start font-normal md:text-base leading-6 md:gap-7">
            Haluatko tietää web-kehityksen uusimmista trendeistä, parhaista käytännöistä ja saada vinkkejä yrityksesi verkkosivujen parantamiseen? 
            Jos kyllä, niin saavuit oikeaan paikkaan.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section class="w-full">
    <div class="max-w-8xl mx-auto md:px-[64px] px-s-3-m pt-s-10-m md:pt-s-10-d pb-20">
      
      <div class="flex justify-between items-end pb-s-5-m md:pb-s-5-d">
        <h2 class="text-h2-m md:text-h2-d font-normal font-heading self-stretch inline-flex items-end">
          Uusimmat artikkelit
        </h2>
        <div class="hidden md:flex justify-center items-end">
             </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-7">
        {
          page.data.map((post) => {
            // Luodaan siisti slug kategoriasta (esim. "Markkinointi" -> "markkinointi")
            // Varmistetaan, että kategoria on olemassa, muuten käytetään tyhjää
            const categorySlug = post.data.category ? post.data.category.toLowerCase().replace(/\s+/g, '-') : 'yleinen';
            
            return (
            <a 
              /* Päivitetty linkkirakenne: /ajankohtaista/kategoria/postaus */
              href={`/ajankohtaista/${categorySlug}/${post.slug}`}
              class="relative w-full h-auto md:h-[600px] rounded-lg inline-flex flex-col justify-start items-start group transition-colors"
              aria-label={`Lue artikkeli: ${post.data.title}`}
            >
              <div class="w-full h-80 relative shadow-[0px_4px_4px_0px_rgba(0,0,0,0.20)] overflow-hidden rounded-sm flex-shrink-0 mb-s-2-m md:mb-s-2-d">
                {post.data.image ? (
                  <img
                    src={post.data.image}
                    alt={post.data.title}
                    class="w-full h-80 left-0 top-0 absolute rounded-sm object-cover transition-transform duration-300 group-hover:scale-105"
                  />
                ) : (
                  <div class="w-full h-80 bg-gray-100 flex items-center justify-center pb-s-2-m">
                    <img
                      src="/images/uploads/logo.webp"
                      alt="Meriadoc Oy"
                      class="h-20 opacity-50"
                    />
                  </div>
                )}
              </div>

              <div class="flex flex-col h-auto w-full md:h-full">
                
                {/* UUSI: Kategoria tässä (Kuvan alla, otsikon päällä) */}
                {/* Siirsin pt-s-2-m tähän, jotta väli kuvaan säilyy oikeana */}
                <div class="pt-s-2-m flex justify-start">
                    <span class="font-body text-sm md:text-base text-neutral-600 mb-1 block">
                        {post.data.category || "Kategoria"}
                    </span>
                </div>

                {/* OTSIKKO (Säilytetty hover-efekti) */}
                <div class="relative mb-0 md:mb-s-2-d flex-shrink-0">
                  {/* Poistin tästä pt-s-2-m, koska se on nyt kategorian päällä */}
                  <h3 class="text-h3-m md:text-h4-d font-heading font-normal text-black line-clamp-2">
                    {post.data.title}
                  </h3>
                  <span class="absolute bottom-0 left-0 w-0 h-[1px] bg-s-brown transition-all duration-300 group-hover:w-full translate-y-2" />
                </div>

                {/* INGRESSI JA PÄIVÄMÄÄRÄ (Täysin ennallaan) */}
                <div class="flex-1 flex flex-col justify-between">
                  <p class="font-body py-s-3-m md:py-s-2-d">
                    {post.data.description}
                  </p>
                  
                  <div class="border-t border-primary pb-s-6-m pt-s-3-m md:pt-s-2-d">
                    <p class="font-body text-sm">{formatDate(post.data.pubDate)}</p>
                  </div>
                </div>
              </div>
            </a>
            );
          })
        }
      </div>

      {page.lastPage > 1 && (
        <div class="flex justify-center items-center gap-6 mt-s-10-m md:mt-s-10-d">
            
          <a 
            href={page.url.prev} 
            class={`w-7 h-7 border-[0.5px] border-black flex items-center justify-center hover:bg-gray-50 transition-colors ${!page.url.prev ? 'pointer-events-none opacity-30' : ''}`}
            aria-label="Edellinen sivu"
          >
            <svg width="22" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
          </a>

          {pageNumbers.map((num) => (
            num === page.currentPage ? (
                /* Aktiivinen sivu: Vihreä tausta, valkoinen teksti */
                <div class="w-7 h-7 px-1 bg-primary inline-flex flex-col justify-center items-center gap-2.5">
                    <span class="text-white text-xl font-normal font-body leading-7">{num}</span>
                </div>
            ) : (
                /* Ei-aktiivinen sivu: Pelkkä numero (Figman mukaisesti) */
                <a 
                    href={num === 1 ? "/ajankohtaista" : `/ajankohtaista/${num}`}
                    class="text-black text-xl font-normal font-body leading-7 hover:text-primary transition-colors"
                >
                    {num}
                </a>
            )
          ))}

          <a 
            href={page.url.next} 
            class={`w-7 h-7 border-[0.5px] border-black flex items-center justify-center hover:bg-gray-50 transition-colors ${!page.url.next ? 'pointer-events-none opacity-30' : ''}`}
            aria-label="Seuraava sivu"
          >
             <svg width="22" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
          </a>

        </div>
      )}

    </div>
  </section>
</Layout>