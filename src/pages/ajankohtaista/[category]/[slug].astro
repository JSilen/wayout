---
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from "astro:content";

// 1. Luodaan polut (URL) jokaiselle postaukselle
export async function getStaticPaths() {
  
  const createSlug = (text) => {
    if (!text) return 'yleinen';
    return text
      .toLowerCase()
      .replace(/ä/g, 'a')
      .replace(/ö/g, 'o')
      .replace(/å/g, 'a')
      .replace(/\s+/g, '-')
      .replace(/[^\w\-]+/g, '');
  };

  const posts = await getCollection("ajankohtaista");
  
  return posts.map((post) => {
    const categorySlug = createSlug(post.data.category);

    return {
      params: { 
        category: categorySlug,
        slug: post.slug 
      },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { Content } = await post.render();

// Formatointi-funktio päivämäärälle
const formatDate = (dateString) => {
  const date = new Date(dateString);
  return date.toLocaleDateString("fi-FI");
};

// Luodaan createSlug myös komponentin käyttöön (Related posts -linkkejä varten)
const createSlugForComponent = (text) => {
  if (!text) return 'yleinen';
  return text
    .toLowerCase()
    .replace(/ä/g, 'a')
    .replace(/ö/g, 'o')
    .replace(/å/g, 'a')
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '');
};

// Haetaan "Sinua voisi kiinnostaa" -postaukset
const allPosts = await getCollection("ajankohtaista");
const relatedPosts = allPosts
  .filter((p) => p.slug !== post.slug)
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf())
  .slice(0, 3);

---

<Layout
  title={post.data.title}
  description={post.data.description}
>
  
  <article class="w-full pt-s-10-m md:pt-s-10-d pb-20">
    <div class="max-w-8xl mx-auto px-s-3-m md:px-[68px]">
      
      <div class="grid grid-cols-1 md:grid-cols-[200px_1fr] gap-8 md:gap-16">
        
        <div class="border-b md:border-b-0 md:border-r border-s-brown pb-6 md:pb-0 md:pr-6">
            <div class="flex flex-row md:flex-col justify-between md:justify-start items-center md:items-start gap-4 h-full">
                
                <div class="px-3 py-1 bg-primary inline-flex justify-center items-center rounded-sm">
                    <span class="text-white text-sm font-bold uppercase tracking-wider font-body">
                        {post.data.category || "BLOGI"}
                    </span>
                </div>

                <div class="text-neutral-600 text-sm font-body">
                    {formatDate(post.data.pubDate)}
                </div>
            </div>
        </div>

        <div class="max-w-4xl min-w-0">
            
            <h1 class="text-h2-m md:text-h2-d font-heading font-normal text-black mb-6 md:mb-8 leading-tight">
                {post.data.title}
            </h1>

            {post.data.image && (
                <div class="w-full aspect-video relative shadow-lg rounded-sm overflow-hidden mb-10 md:mb-12">
                    <img 
                        src={post.data.image} 
                        alt={post.data.title}
                        class="w-full h-full object-cover"
                    />
                </div>
            )}
            
            <p class="text-xl md:text-xl font-body leading-relaxed mb-8 md:mb-10 font-medium">
                {post.data.description}
            </p>

            <div class="prose prose-lg prose-headings:font-heading prose-headings:font-normal prose-p:font-body prose-a:text-primary hover:prose-a:text-emerald-700 max-w-none">
                <Content />
            </div>

        </div>
      </div>


      <div class="mt-20 md:mt-32 border-t border-s-brown pt-16">
        <h3 class="text-h3-m md:text-h3-d font-heading mb-10 text-black">
            Sinua voisi kiinnostaa
        </h3>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-7">
            {
              relatedPosts.map((relatedPost) => {
                 // Käytetään tässä sitä toista funktiota, joka on tässä scopessa
                 const catSlug = createSlugForComponent(relatedPost.data.category);
    
                 return (
                <a 
                  href={`/ajankohtaista/${catSlug}/${relatedPost.slug}`}
                  class="relative w-full h-auto md:h-[600px] rounded-lg inline-flex flex-col justify-start items-start group transition-colors"
                >
                  <div class="w-full h-80 relative shadow-[0px_4px_4px_0px_rgba(0,0,0,0.20)] overflow-hidden rounded-sm flex-shrink-0 mb-s-2-m md:mb-s-2-d">
                    {relatedPost.data.image ? (
                      <img
                        src={relatedPost.data.image}
                        alt={relatedPost.data.title}
                        class="w-full h-80 left-0 top-0 absolute rounded-sm object-cover transition-transform duration-300 group-hover:scale-105"
                      />
                    ) : (
                      <div class="w-full h-80 bg-gray-100 flex items-center justify-center pb-s-2-m">
                         <span class="text-gray-400">Ei kuvaa</span>
                      </div>
                    )}
                  </div>
    
                  <div class="flex flex-col h-auto w-full md:h-full">
                    
                    <div class="pt-s-2-m flex justify-start">
                        <span class="font-body text-sm md:text-base text-neutral-600 mb-1 block">
                            {relatedPost.data.category || "Kategoria"}
                        </span>
                    </div>
    
                    <div class="relative mb-0 md:mb-s-2-d flex-shrink-0">
                      <h3 class="text-h3-m md:text-h4-d font-heading font-normal text-black line-clamp-2">
                        {relatedPost.data.title}
                      </h3>
                      <span class="absolute bottom-0 left-0 w-0 h-[1px] bg-s-brown transition-all duration-300 group-hover:w-full translate-y-2" />
                    </div>
    
                    <div class="flex-1 flex flex-col justify-between">
                      <p class="font-body py-s-3-m md:py-s-2-d line-clamp-4">
                        {relatedPost.data.description}
                      </p>
                      
                      <div class="border-t border-primary pb-s-6-m pt-s-3-m md:pt-s-2-d">
                        <p class="font-body text-sm">{formatDate(relatedPost.data.pubDate)}</p>
                      </div>
                    </div>
                  </div>
                </a>
              )})
            }
          </div>
      </div>

    </div>
  </article>
</Layout>